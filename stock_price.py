# -*- coding: utf-8 -*-
"""stock_price.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1_rEpoSCbDKFCJE7QCK0DexxAIo7V_zqj
"""

import os
from statsmodels.tsa.arima.model import ARIMA
import joblib as jb
import pandas as pd
from sklearn.metrics import root_mean_squared_error
path="data"
company_data={}
for file in os.listdir(path):
    if file.endswith(".csv"):
        company=file.replace(".csv","")
        df=pd.read_csv(os.path.join(path,file))
        company_data[company]=df
print("Total companies loaded:", len(company_data))
for company, df in company_data.items():
    print(f"\n{company} - First 5 rows")
    print(df.head())


#preprocess
def preprocess(df):
    df['date']=pd.to_datetime(df['date'],dayfirst=True, format='mixed',
    errors='coerce')
    df=df.sort_values('date')
    df.set_index('date', inplace=True)
    # Resample to daily frequency, taking the last close price of the day
    df_daily = df['close'].resample('D').last().dropna().to_frame()
    return df_daily[['close']]

processed_data = {}

for company, df in company_data.items():
    processed_data[company] = preprocess(df)
print("Companies found:", list(processed_data.keys()))

import matplotlib.pyplot as plt  # noqa: E402
processed_data['INDIA VIX_minute']['close'].plot(title="INDIA VIX_minute Closing Price",color="red")
plt.show()


#processed_data['NIFTY AUTO_minute']['close'].plot(title="NIFTY AUTO_minute Closing Price",color="red")
#plt.show()

#adf test(stationarity) check
from statsmodels.tsa.stattools import adfuller  # noqa: E402
def adf_test(timeseries):
    result=adfuller(timeseries.dropna(),autolag=None,maxlag=1)
    return result[1]
adf_results={}
for company,df in processed_data.items():
    p_value=adf_test(df['close'])
    adf_results[company]=p_value
print(adf_results)

differenced_data = {}
for company, df in processed_data.items():
    differenced_data[company] = df['close'].diff().dropna()

differenced_data['NIFTY ENERGY_minute'].plot(title="Differencing Data",color='orange')
plt.show()
adf_test(differenced_data['INDIA VIX_minute'])
adf_test(differenced_data['NIFTY ALPHA 50_minute'])



#model training
def split_series(series, test_size=0.2):
    split = int(len(series) * (1 - test_size))
    return series[:split], series[split:]

for company, series in differenced_data.items():
    train, test = split_series(series)

    # Explicitly set the frequency to 'D' for daily data
    if isinstance(train.index, pd.DatetimeIndex):
        train.index = train.index.to_period('D').to_timestamp('D', how='start')

    model = ARIMA(
        train,
        order=(0,0,0),
        seasonal_order=(0,0,0,0),
        trend=None
    )
    res=model.fit()

    # Store the last actual (undifferenced) close price
    last_original_close = processed_data[company]['close'].iloc[-1]
    df1=processed_data

    model_data = {
        "model": res,
        "last_date": series.index[-1],
        "last_original_close": last_original_close,
        "history":df1# Save last original close price
    }
    jb.dump(model_data,f"model/{company}_model.pkl")

res1=res.forecast(steps=len(test))
print(f"Result:\n{res1}")

print(f"Root Mean Squared Error:{root_mean_squared_error(test.values,res1.values)}")
